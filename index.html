<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Calendar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f7f7;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .person-inputs {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .person-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .controls label, .controls input, .controls select, .controls button {
            margin: 10px;
        }
        .calendar-container {
            overflow-x: auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        #calendar {
            display: flex;
            flex-direction: column;
        }
        .year-row {
            display: flex;
            margin-bottom: 4px;
        }
        .year-label {
            width: 50px;
            text-align: right;
            margin-right: 10px;
            font-size: 12px;
            color: #666;
            line-height: 12px;
        }
        .month-group {
            display: flex;
            margin-right: 4px;
            border-right: 1px dotted #eee;
        }
        .month-group:last-child {
            margin-right: 0;
            border-right: none;
        }
        .week {
            width: 10px;
            height: 10px;
            margin: 1px;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            background-color: #ddd;
            transition: background-color 0.3s;
        }
        .pre-birth-week {
            background-color: #1a1a1a;
        }
        .past-week-1 {
            background-color: #4a6fa5;
        }
        .past-week-2 {
            background-color: #a55a4a;
        }
        .past-week-both {
            background-color: #8844aa;
        }
        .after-person1-death {
            background-color: #a55a4a;
            opacity: 0.7;
        }
        .after-person2-death {
            background-color: #4a6fa5;
            opacity: 0.7;
        }
        .after-both-death {
            background-color: #1a1a1a;
            opacity: 0.5;
        }
        .current-week-1 {
            background-color: #5b8ce5;
            animation: pulse 2s infinite;
        }
        .current-week-2 {
            background-color: #e5735b;
            animation: pulse 2s infinite;
        }
        .average-line-1, .median-line-1, .average-line-2, .median-line-2 {
            position: absolute;
            height: 2px;
            width: 100%;
            left: 0;
            display: none;
            z-index: 5;
        }
        .average-line-1 {
            background-color: #4a6fa5;
        }
        .median-line-1 {
            background-color: #2a4a8a;
        }
        .average-line-2 {
            background-color: #a55a4a;
        }
        .median-line-2 {
            background-color: #8a2a2a;
        }
        .line-label {
            position: absolute;
            right: 10px;
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .legend {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .screenshot-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 15px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .screenshot-btn:hover {
            background-color: #3a5a85;
        }
        .checkbox-container {
            margin: 10px;
            display: flex;
            align-items: center;
        }
        .checkbox-container input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Life Calendar</h1>
    
    <div class="controls">
        <div class="person-inputs" id="person1-inputs">
            <div class="person-title">Person 1</div>
            <label for="name1">Name:</label>
            <input type="text" id="name1" placeholder="Enter name" value="Person 1">
            
            <label for="birthdate1">Birth Date:</label>
            <input type="date" id="birthdate1" required>
            
            <label for="gender1">Biological Sex:</label>
            <select id="gender1">
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
            
            <div class="checkbox-container">
                <input type="checkbox" id="show-person1" checked>
                <label for="show-person1">Show</label>
            </div>
        </div>
        
        <div class="person-inputs" id="person2-inputs">
            <div class="person-title">Person 2</div>
            <label for="name2">Name:</label>
            <input type="text" id="name2" placeholder="Enter name" value="Person 2">
            
            <label for="birthdate2">Birth Date:</label>
            <input type="date" id="birthdate2">
            
            <label for="gender2">Biological Sex:</label>
            <select id="gender2">
                <option value="female">Female</option>
                <option value="male">Male</option>
            </select>
            
            <div class="checkbox-container">
                <input type="checkbox" id="show-person2">
                <label for="show-person2">Show</label>
            </div>
        </div>
        
        <button id="generate">Generate Calendar</button>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot" style="background-color: #1a1a1a;"></div>
            <span>Pre-Birth</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background-color: #4a6fa5;"></div>
            <span id="person1-legend">Person 1 Only</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background-color: #a55a4a;"></div>
            <span id="person2-legend">Person 2 Only</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background-color: #8844aa;"></div>
            <span>Both People</span>
        </div>
    </div>
    
    <div class="calendar-container">
        <div id="calendar"></div>
        <div id="average-line-1" class="average-line-1">
            <span class="line-label">Person 1 Average</span>
        </div>
        <div id="median-line-1" class="median-line-1">
            <span class="line-label">Person 1 Median</span>
        </div>
        <div id="average-line-2" class="average-line-2">
            <span class="line-label">Person 2 Average</span>
        </div>
        <div id="median-line-2" class="median-line-2">
            <span class="line-label">Person 2 Median</span>
        </div>
    </div>
    
    <button id="screenshot" class="screenshot-btn">Save as Image</button>
    
    <footer>
        <p>Life Calendar Visualization â€” Created on <span id="creation-date"></span></p>
        <p>Inspired by Tim Urban's <a href="https://waitbutwhy.com/2014/05/life-weeks.html" target="_blank">Life Calendar</a></p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date in footer
            document.getElementById('creation-date').textContent = new Date().toLocaleDateString();
            
            // Life expectancy data (simplified actuarial data)
            // These are approximate values based on US life tables
            const lifeExpectancy = {
                male: {
                    average: 76,
                    median: 78
                },
                female: {
                    average: 81,
                    median: 83
                }
            };
            
            // Event listeners
            document.getElementById('generate').addEventListener('click', generateCalendar);
            document.getElementById('screenshot').addEventListener('click', takeScreenshot);
            document.getElementById('show-person1').addEventListener('change', generateCalendar);
            document.getElementById('show-person2').addEventListener('change', generateCalendar);
            document.getElementById('name1').addEventListener('input', updateLegend);
            document.getElementById('name2').addEventListener('input', updateLegend);
            
            // Update legend based on entered names
            function updateLegend() {
                const name1 = document.getElementById('name1').value || 'Person 1';
                const name2 = document.getElementById('name2').value || 'Person 2';
                
                document.getElementById('person1-legend').textContent = name1 + ' Only';
                document.getElementById('person2-legend').textContent = name2 + ' Only';
            }
            
            // Generate calendar on page load with default dates if not set
            if (!document.getElementById('birthdate1').value) {
                // Default to 30 years ago for person 1
                const defaultDate1 = new Date();
                defaultDate1.setFullYear(defaultDate1.getFullYear() - 30);
                document.getElementById('birthdate1').value = defaultDate1.toISOString().split('T')[0];
            }
            
            if (!document.getElementById('birthdate2').value) {
                // Default to 25 years ago for person 2
                const defaultDate2 = new Date();
                defaultDate2.setFullYear(defaultDate2.getFullYear() - 25);
                document.getElementById('birthdate2').value = defaultDate2.toISOString().split('T')[0];
            }
            
            // Initialize legend
            updateLegend();
            
            function generateCalendar() {
                const showPerson1 = document.getElementById('show-person1').checked;
                const showPerson2 = document.getElementById('show-person2').checked;
                
                // Validate at least one person is shown
                if (!showPerson1 && !showPerson2) {
                    alert('Please check at least one person to display');
                    return;
                }
                
                const name1 = document.getElementById('name1').value || 'Person 1';
                const name2 = document.getElementById('name2').value || 'Person 2';
                
                const gender1 = document.getElementById('gender1').value;
                const birthdate1String = document.getElementById('birthdate1').value;
                const birthdate1 = showPerson1 ? new Date(birthdate1String) : null;
                
                const gender2 = document.getElementById('gender2').value;
                const birthdate2String = document.getElementById('birthdate2').value;
                const birthdate2 = showPerson2 ? new Date(birthdate2String) : null;
                
                if (showPerson1 && !birthdate1String) {
                    alert('Please enter a birth date for ' + name1);
                    return;
                }
                
                if (showPerson2 && !birthdate2String) {
                    alert('Please enter a birth date for ' + name2);
                    return;
                }
                
                const today = new Date();
                
                // Clear previous calendar
                const calendarEl = document.getElementById('calendar');
                calendarEl.innerHTML = '';
                
                // Find the oldest birthdate to start the calendar
                let oldestBirthdate = null;
                if (showPerson1 && showPerson2) {
                    oldestBirthdate = birthdate1 < birthdate2 ? birthdate1 : birthdate2;
                } else if (showPerson1) {
                    oldestBirthdate = birthdate1;
                } else {
                    oldestBirthdate = birthdate2;
                }
                
                // Start from January of the birth year of the oldest person
                const startDate = new Date(oldestBirthdate.getFullYear(), 0, 1);
                
                // Get the exact birth weeks (counting from start date)
                const getBirthWeek = (birthdate) => {
                    const diffTime = birthdate - startDate;
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);
                    return Math.floor(diffDays / 7);
                };
                
                const birthWeek1 = showPerson1 ? getBirthWeek(birthdate1) : null;
                const birthWeek2 = showPerson2 ? getBirthWeek(birthdate2) : null;
                
                // Calculate current week (counting from start date)
                const currentTime = today - startDate;
                const currentDays = currentTime / (1000 * 60 * 60 * 24);
                const currentWeek = Math.floor(currentDays / 7);
                
                // Calculate life expectancy years from birth (not weeks)
                // Get average and median life expectancy years
                let avgLifeExpectancy1Years = 0;
                let medianLifeExpectancy1Years = 0;
                let avgLifeExpectancy2Years = 0;
                let medianLifeExpectancy2Years = 0;
                
                if (showPerson1) {
                    avgLifeExpectancy1Years = lifeExpectancy[gender1].average;
                    medianLifeExpectancy1Years = lifeExpectancy[gender1].median;
                }
                
                if (showPerson2) {
                    avgLifeExpectancy2Years = lifeExpectancy[gender2].average;
                    medianLifeExpectancy2Years = lifeExpectancy[gender2].median;
                }
                
                // Calculate weeks for life expectancies (we'll use these for coloring change)
                const getLifeExpectancyWeek = (birthWeek, lifeExpectancyYears) => {
                    return birthWeek + (lifeExpectancyYears * 52);
                };
                
                let avgLifeExpectancyWeek1 = 0;
                let avgLifeExpectancyWeek2 = 0;
                
                if (showPerson1) {
                    avgLifeExpectancyWeek1 = getLifeExpectancyWeek(birthWeek1, avgLifeExpectancy1Years);
                }
                
                if (showPerson2) {
                    avgLifeExpectancyWeek2 = getLifeExpectancyWeek(birthWeek2, avgLifeExpectancy2Years);
                }
                
                // Create calendar with each row representing a year
                const weeksPerYear = 52;
                // Define month groups (approximate weeks per month)
                const monthGroups = [4, 4, 5, 4, 4, 5, 4, 5, 4, 4, 5, 4]; // 52 weeks total
                
                // Determine the end date (90 years after the latest birth)
                let latestBirthWeek = 0;
                if (showPerson1 && showPerson2) {
                    latestBirthWeek = Math.max(birthWeek1, birthWeek2);
                } else if (showPerson1) {
                    latestBirthWeek = birthWeek1;
                } else {
                    latestBirthWeek = birthWeek2;
                }
                
                const endWeek = latestBirthWeek + (90 * 52); // 90 years after the latest birth
                
                // Function to calculate age at a specific week
                const calculateAge = (birthWeek, currentWeek) => {
                    if (birthWeek === null || currentWeek < birthWeek) {
                        return "Not born yet";
                    }
                    
                    const weeksLived = currentWeek - birthWeek;
                    const yearsLived = Math.floor(weeksLived / 52);
                    const remainingWeeks = weeksLived % 52;
                    
                    return `${yearsLived} years, ${remainingWeeks} weeks`;
                };
                
                // Generate the calendar
                let totalWeekCounter = 0;
                
                for (let year = 0; year < 150; year++) { // 150 is a safe upper limit
                    const calendarYear = startDate.getFullYear() + year;
                    
                    const yearRow = document.createElement('div');
                    yearRow.className = 'year-row';
                    
                    // Add year label
                    const yearLabel = document.createElement('div');
                    yearLabel.className = 'year-label';
                    yearLabel.textContent = calendarYear;
                    yearRow.appendChild(yearLabel);
                    
                    let monthCounter = 0;
                    // Create month groups
                    for (let month = 0; month < monthGroups.length; month++) {
                        const monthGroup = document.createElement('div');
                        monthGroup.className = 'month-group';
                        
                        for (let w = 0; w < monthGroups[month]; w++) {
                            const weekDiv = document.createElement('div');
                            weekDiv.className = 'week';
                            
                            // Determine the state of this week
                            const isPastCurrentDate = totalWeekCounter < currentWeek;
                            const isCurrentWeek = totalWeekCounter === currentWeek;
                            
                            const isPerson1Born = showPerson1 && totalWeekCounter >= birthWeek1;
                            const isPerson2Born = showPerson2 && totalWeekCounter >= birthWeek2;
                            
                            const isPerson1Dead = showPerson1 && totalWeekCounter >= avgLifeExpectancyWeek1;
                            const isPerson2Dead = showPerson2 && totalWeekCounter >= avgLifeExpectancyWeek2;
                            
                            // Create tooltip content
                            const dateOfWeek = new Date(startDate.getTime() + totalWeekCounter * 7 * 24 * 60 * 60 * 1000);
                            const monthName = dateOfWeek.toLocaleString('default', { month: 'short' });
                            const yearOfWeek = dateOfWeek.getFullYear();
                            let tooltipContent = `Date: ${monthName} ${dateOfWeek.getDate()}, ${yearOfWeek}`;
                            
                            if (showPerson1) {
                                const person1Age = calculateAge(birthWeek1, totalWeekCounter);
                                tooltipContent += `\n${name1}: ${person1Age}`;
                                if (isPerson1Dead && totalWeekCounter >= avgLifeExpectancyWeek1) {
                                    tooltipContent += " (Expected death)";
                                }
                            }
                            
                            if (showPerson2) {
                                const person2Age = calculateAge(birthWeek2, totalWeekCounter);
                                tooltipContent += `\n${name2}: ${person2Age}`;
                                if (isPerson2Dead && totalWeekCounter >= avgLifeExpectancyWeek2) {
                                    tooltipContent += " (Expected death)";
                                }
                            }
                            
                            // Apply the appropriate CSS class for coloring
                            if (isCurrentWeek) {
                                if (isPerson1Born && !isPerson2Born) {
                                    weekDiv.classList.add('current-week-1');
                                } else if (isPerson2Born && !isPerson1Born) {
                                    weekDiv.classList.add('current-week-2');
                                }
                            } else if (isPastCurrentDate) {
                                // Pre-birth period
                                if (!isPerson1Born && !isPerson2Born) {
                                    weekDiv.classList.add('pre-birth-week');
                                }
                                // One person alive period
                                else if (isPerson1Born && !isPerson2Born && !isPerson1Dead) {
                                    weekDiv.classList.add('past-week-1');
                                }
                                else if (isPerson2Born && !isPerson1Born && !isPerson2Dead) {
                                    weekDiv.classList.add('past-week-2');
                                }
                                // Both alive period
                                else if (isPerson1Born && isPerson2Born && !isPerson1Dead && !isPerson2Dead) {
                                    weekDiv.classList.add('past-week-both');
                                }
                                // After first death
                                else if (isPerson1Born && isPerson2Born && isPerson1Dead && !isPerson2Dead) {
                                    weekDiv.classList.add('after-person1-death');
                                }
                                else if (isPerson1Born && isPerson2Born && !isPerson1Dead && isPerson2Dead) {
                                    weekDiv.classList.add('after-person2-death');
                                }
                                // After both deaths
                                else if (isPerson1Dead && isPerson2Dead) {
                                    weekDiv.classList.add('pre-birth-week');
                                    weekDiv.style.opacity = "0.5";
                                }
                                // Special cases for one person only
                                else if (showPerson1 && !showPerson2 && isPerson1Dead) {
                                    weekDiv.classList.add('pre-birth-week');
                                    weekDiv.style.opacity = "0.5";
                                }
                                else if (!showPerson1 && showPerson2 && isPerson2Dead) {
                                    weekDiv.classList.add('pre-birth-week');
                                    weekDiv.style.opacity = "0.5";
                                }
                            }
                            // Future periods
                            else {
                                if (isPerson1Dead && isPerson2Dead) {
                                    weekDiv.classList.add('pre-birth-week');
                                    weekDiv.style.opacity = "0.5";
                                }
                                else if (isPerson1Dead && !isPerson2Dead) {
                                    weekDiv.classList.add('after-person1-death');
                                }
                                else if (!isPerson1Dead && isPerson2Dead) {
                                    weekDiv.classList.add('after-person2-death');
                                }
                                else if (isPerson1Born && isPerson2Born) {
                                    weekDiv.classList.add('past-week-both');
                                    weekDiv.style.opacity = "0.3";
                                }
                                else if (isPerson1Born) {
                                    weekDiv.classList.add('past-week-1');
                                    weekDiv.style.opacity = "0.3";
                                }
                                else if (isPerson2Born) {
                                    weekDiv.classList.add('past-week-2');
                                    weekDiv.style.opacity = "0.3";
                                }
                                else {
                                    // Just keep it gray for pre-birth future
                                }
                            }
                            
                            weekDiv.title = tooltipContent;
                            monthGroup.appendChild(weekDiv);
                            totalWeekCounter++;
                        }
                        
                        yearRow.appendChild(monthGroup);
                        monthCounter++;
                    }
                    
                    calendarEl.appendChild(yearRow);
                    
                    // Stop generating if we've reached our target end week
                    if (totalWeekCounter >= endWeek) {
                        break;
                    }
                }
                
                // Add life expectancy lines
                const avgLine1 = document.getElementById('average-line-1');
                const medianLine1 = document.getElementById('median-line-1');
                const avgLine2 = document.getElementById('average-line-2');
                const medianLine2 = document.getElementById('median-line-2');
                
                // Reset all lines
                avgLine1.style.display = 'none';
                medianLine1.style.display = 'none';
                avgLine2.style.display = 'none';
                medianLine2.style.display = 'none';
                
                // Find exact birth year row positions in the DOM
                const findYearRowPosition = (yearFromStart) => {
                    const yearRows = document.querySelectorAll('.year-row');
                    if (yearRows.length > yearFromStart) {
                        const rect = yearRows[yearFromStart].getBoundingClientRect();
                        const containerRect = calendarEl.getBoundingClientRect();
                        return rect.top - containerRect.top + 7; // center of row
                    }
                    return null;
                };
                
                // Set person 1 lines
                if (showPerson1) {
                    const avgYearFromStart = Math.floor((avgLifeExpectancyWeek1 - birthWeek1) / 52) + Math.floor(birthWeek1 / 52);
                    const medianYearFromStart = Math.floor((medianLifeExpectancyWeek1 - birthWeek1) / 52) + Math.floor(birthWeek1 / 52);
                    
                    // Average line
                    avgLine1.style.display = 'block';
                    const avgPosition = findYearRowPosition(avgYearFromStart);
                    if (avgPosition !== null) {
                        avgLine1.style.top = `${avgPosition}px`;
                    } else {
                        // Fallback calculation if DOM positioning fails
                        avgLine1.style.top = `${avgYearFromStart * 14 + 7}px`;
                    }
                    avgLine1.querySelector('.line-label').textContent = `${name1} Average Life Expectancy (${lifeExpectancy[gender1].average} years)`;
                    
                    // Median line
                    medianLine1.style.display = 'block';
                    const medianPosition = findYearRowPosition(medianYearFromStart);
                    if (medianPosition !== null) {
                        medianLine1.style.top = `${medianPosition}px`;
                    } else {
                        // Fallback calculation if DOM positioning fails
                        medianLine1.style.top = `${medianYearFromStart * 14 + 7}px`;
                    }
                    medianLine1.querySelector('.line-label').textContent = `${name1} Median Life Expectancy (${lifeExpectancy[gender1].median} years)`;
                }
                
                // Set person 2 lines
                if (showPerson2) {
                    const avgYearFromStart = Math.floor((avgLifeExpectancyWeek2 - birthWeek2) / 52) + Math.floor(birthWeek2 / 52);
                    const medianYearFromStart = Math.floor((medianLifeExpectancyWeek2 - birthWeek2) / 52) + Math.floor(birthWeek2 / 52);
                    
                    // Average line
                    avgLine2.style.display = 'block';
                    const avgPosition = findYearRowPosition(avgYearFromStart);
                    if (avgPosition !== null) {
                        avgLine2.style.top = `${avgPosition}px`;
                    } else {
                        // Fallback calculation if DOM positioning fails
                        avgLine2.style.top = `${avgYearFromStart * 14 + 7}px`;
                    }
                    avgLine2.querySelector('.line-label').textContent = `${name2} Average Life Expectancy (${lifeExpectancy[gender2].average} years)`;
                    
                    // Median line
                    medianLine2.style.display = 'block';
                    const medianPosition = findYearRowPosition(medianYearFromStart);
                    if (medianPosition !== null) {
                        medianLine2.style.top = `${medianPosition}px`;
                    } else {
                        // Fallback calculation if DOM positioning fails
                        medianLine2.style.top = `${medianYearFromStart * 14 + 7}px`;
                    }
                    medianLine2.querySelector('.line-label').textContent = `${name2} Median Life Expectancy (${lifeExpectancy[gender2].median} years)`;
                }
            }
            
            function takeScreenshot() {
                html2canvas(document.querySelector('.calendar-container')).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'life-calendar.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            }
            
            // Generate default calendar
            generateCalendar();
        });
    </script>
</body>
</html>
